{% extends "menu.html" %}
{% load staticfiles %}

{% block corpusBannerTop %}

<div class="container theme-showcase" role="main">
        <div class="jumbotron">


		<div class="row">
				<div class="col-md-4">

						{% if project %}
						<h1><a href="/project/{{project.id}}">{{ project.name }}</a></h1>
						<h2>{{ corpus.name }}</h2>
						{% endif %}
										<!--<a class="btn btn-primary btn-lg" role="button" href="/admin/documents/corpus/{{ corpus.id }}/">Add file</a> -->

				</div>
		
				<div class="col-md-4">
						{% if corpus %}
								<br>
								<p>
								<center>
								Creation date:
								<br>
								{{ corpus.date }} 
								</center>
								</p>
						{% endif %}
				</div>

				<div class="col-md-4">
						<br>
						<a class="btn btn-default btn-lg" role="button" href="/project/{{project.id}}/corpus/{{corpus.id}}/{{view}}/update">Update</a>

						<a class="btn btn-default btn-lg" role="button" href="/project/{{project.id}}/corpus/{{ corpus.id }}/corpus.csv">Download</a>
						<a type="button" class="btn btn-default btn-lg" data-container="body" data-toggle="popover" data-placement="bottom" 
																		data-content='
																		<ul>
																		<li> Rename </li>
																		<li> Add new documents </li>
																		<li><a href="/delete/{{corpus.id}}">Delete</a></li>
																		</ul>
																		'>Manage</a>

						{% if number == 0 %}
								<a class="btn btn-primary btn-lg" role="button" href="/admin/documents/corpus/{{ corpus.id }}/">Add documents</a></p>
						{% endif %}
						{% if nb_groups != None and nb_groups > 0 %}
								<a id="share_button" class="btn btn-primary btn-lg" role="button" >Share!!!</a></p>
						{% endif %}
				</div>
</div>

		<div class="btn-group btn-group-justified">
				<center>
				<a type="button" class="btn btn-default {% if view == "documents" %}active{%endif%}" href="/project/{{project.id}}/corpus/{{ corpus.id }}/documents">{{number}} Documents</a>
							<a type="button" class="btn btn-default {% if view == "journals" %}active{%endif%}" href="/project/{{project.id}}/corpus/{{ corpus.id }}/journals">Journals</a>
							{% if processing == 0 or processing == "0" %}
							<a type="button" class="btn btn-default {% if view == "terms" %}active{%endif%}" href="/project/{{project.id}}/corpus/{{ corpus.id }}/terms">Terms (Bêta)</a>
							{% endif %}
				</center>
		</div>

{% endblock %}


{% block corpusBannerBottom %}

<div class="container">
		<div class="row">
				<div class="col-md-6">
						<div class="jumbotron">
						<h3><a href="/project/{{project.id}}/corpus/{{corpus.id}}/chart">Advanced charts</a></h3>
						<ol>
								<li>Count</li> <!-- read, compute -->
                    <ol>
                        <li> Documents </li>
                        <li> Terms or Expressions</li>
                    </ol>
								<li>Filter</li> <!-- count, compute -->
								<li>Compare</li> <!-- select, cut -->
						</ol>
						<h4><a href="/project/{{project.id}}/corpus/{{corpus.id}}/">Back to corpus</a></h3>
					</div>
				</div>

				<span style="display:none;" id="process_state">{{processing}}</span>
				<span style="display:none;" id="corpus_id">{{corpus.id}}</span>
				<div class="col-md-6">
						<div class="jumbotron">
				{% if processing == 0 or processing == "0" %}
                        <h3> Networks </h3>
                        <ol>
                                <li data-url="/project/{{project.id}}/corpus/{{ corpus.id }}/explorer?field1=ngrams&amp;field2=ngrams" onclick='gotoexplorer(this)'><a>Terms</a></li>
                                <ul>
                                    <li data-url="/project/{{project.id}}/corpus/{{ corpus.id }}/explorer?field1=ngrams&amp;field2=ngrams&amp;distance=distributional&amp;bridgeness=5" onclick='gotoexplorer(this)'><a>Meso ++</a></li>
                                    <li data-url="/project/{{project.id}}/corpus/{{ corpus.id }}/explorer?field1=ngrams&amp;field2=ngrams&amp;distance=conditional&amp;bridgeness=5" onclick='gotoexplorer(this)'><a>Meso --</a></li>
                                </ul>
                                <li data-url="/project/{{project.id}}/corpus/{{ corpus.id }}/explorer?field1=journal&amp;field2=ngrams" onclick='gotoexplorer(this)'><a>Journals and Terms</a></li>
                                <li>Authors and Terms</li>
                        </ol>
                {% else %}
                		
						<h3><img width="20px" src="{% static "js/libs/img2/loading-bar.gif" %}"></img> Networks </h3>
						<h6>(Updating: <i id="process_id" data-since="date" >{{processing}}</i>)</h6>
                        <ol>
                                <li>Terms</li>
                                <li>Journals and Terms</li>
                                <li>Authors and Terms</li>
                        </ol>
                {% endif %}
                        <h4><a href="/project/{{project.id}}/corpus/{{corpus.id}}/">Back to corpus</a></h3>
                        </div>
                </div>
        </div>
</div>
</div>
</div>


<div id="sharemodal" class="modal fade">

  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 class="modal-title">Share this Corpus with your Groups</h3>
      </div>

      <div class="modal-body form-horizontal">
      	<h4>List of available groups:</h4>
        <div id="groups_list">here show the groups</div>

        <div class="modal-footer">
          <button id="closesharemodal" type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          <button id="send_share" type="button" class="btn btn-primary" >Share</button>
        </div>

      </div>

    </div>


  </div> 

</div>

<style>
label {
 padding:10px;
 margin:0 0 10px;
 display:block; 
}
label:hover {
 background:#eee;
 cursor:pointer;
}
</style>

<script type="text/javascript">
	function gotoexplorer(elem) {

		var url_ = $(elem).data("url")
		if (TheBuffer==false)
			return window.open(url_,'_blank');

        var current_timerange = TheBuffer
		var time_limits = [new Date(oldest[0],oldest[1]-1,oldest[2]), new Date(latest[0],latest[1]-1,latest[2] ) ];
		time_limits[0] = new Date(time_limits[0].setDate(time_limits[0].getDate()-1) );
		time_limits[1] = new Date(time_limits[1].setDate(time_limits[1].getDate()+1) );
		if( ( +current_timerange[0]===+time_limits[0] ) &&  ( +current_timerange[1]===+time_limits[1] ) ) {
			url_ = url_ // rien
		} else {
			var start__ = new Date(current_timerange[0].setDate(current_timerange[0].getDate()+1) );
			var end__ = new Date(current_timerange[1].setDate(current_timerange[1].getDate()-1) );
			var start_ = start__.getFullYear()+"-"+(start__.getMonth()+1)+"-"+(start__.getDay()+1)
			var end_ = end__.getFullYear()+"-"+(end__.getMonth()+1)+"-"+(end__.getDay()+1)
			url_ += "&start=" + start_ + "&end="+end_;
			// url_ += "&start=" + start__.getFullYear() + "&end="+end__.getFullYear();
		}
		return window.open(url_,'_blank');
	}

	var refresh_time = 10000 //ms
	function corpus_monitorer() {
		var url_ = "/api/corpus/"+$("#corpus_id").text()
		$.ajax({
		    type: "GET",
		    url: url_,
		    dataType: "json",
		    success : function(data, textStatus, jqXHR) {
		        if(data["Processing"]=="0") {
		        	window.location.reload()
		        } else {
		        	$("#process_id").html(data["Processing"]+"...")
		        }
		    },
		    error: function(exception) { 
		        console.log("exception!:"+exception.status)
		    }

		});
	}
	if( $("#process_state").text()=="0" ) {
		// workflow : finished!
	} else {
		setInterval(corpus_monitorer ,refresh_time);
	}



	function get_groups() {
		console.log( "IN get_groups()!" )
		var url_ = "/get_groups"
		$.ajax({
		    type: "GET",
		    url: url_,
		    dataType: "json",
		    success : function(data, textStatus, jqXHR) {
		    	var _content = ""
		    	for(var i in data) {
		    		var g_id = data[i][0] , g_name=data[i][1] 
					_content += '<label><input name="groups" data-id="'+g_id+'" type="checkbox" />&nbsp;'+g_name+'</label>'
		    	}
		    	$("#groups_list").html( _content )
		    },
		    error: function(exception) { 
		        console.log("exception!:"+exception.status)
		    }

		});
	}

	if( $("#share_button").length>0 ) {

		$("#share_button").click(function() {
			get_groups()
			$("#sharemodal").modal("show");
		});

		$("#send_share").click(function() {
			$('input[name=groups]:checked').each(function () {
				console.log( $(this).data("id") );
			});
		});

	}


</script>


{% endblock %}



