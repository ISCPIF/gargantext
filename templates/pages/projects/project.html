{% extends "pages/menu.html" %}

{% block css %}
{% load staticfiles %}
<link rel="stylesheet" href="{% static "lib/bootstrap/3.0.2/bootstrap.css" %}">
<script type="text/javascript" src="{% static "lib/jquery/1.11.1/jquery.min.js" %}"></script>
<script type="text/javascript" src="{% static "lib/gargantext/garganrest.js" %}"></script>
<link rel="stylesheet" href="{% static "lib/jquery/1.11.2/jquery-ui.css" %}">

<script type="text/javascript" src="{% static "lib/morris/morris.min.js" %}"></script>
<link rel="stylesheet" href="{% static "lib/morris/morris.css" %}">

<script src="{% static "lib/raphael/raphael-min.js"%}"></script>

<style type="text/css">
    .ui-autocomplete {
        z-index: 5000;
    }
    .ui-autocomplete .ui-menu-item {
        font-size:x-small;
    }

    .statusinfo {
        margin-top: .3em;
        color: grey ;
    }

    ul.inside-popover {
      padding: .5em ;
      list-style-type: none ;
    }
</style>
{% endblock %}



{% block content %}


<div class="container theme-showcase" role="main">
    <div class="jumbotron">
        <div class="row">
            <div class="col-md-6">
                {% if project %}
                <h1>
                    <span class="glyphicon glyphicon-book" aria-hidden="true"></span>
                    {{ project.name | truncatechars:25 }}</h1>
                <!--<h3> {{number}} corpora </h3>-->
                {% endif %}
            </div>

            <div class="col-md-4">
                <p>
                    {% if donut %}
                    <div id="hero-donut" style="height: 200px;"></div>
                    {% endif %}

                    <center id="corpus" class="help">

                      
                        <a  data-toggle="modal" href="#addcorpus" >
                            <button
                            type="button"
                            class="btn btn-primary btn-lg"
                            data-container="body"
                            data-toggle="popover"
                            data-placement="bottom"
                            >
                            <span class="glyphicon glyphicon-plus" aria-hidden="true" ></span>
                            Add a corpus
                            </button>

                        </a>


                    </center>


                </p>
            </div>
    </div>

</div>


<!-- Add jumbotron container for each type of corpus (presse, science etc.) -->
<div id="semLoader" style="position:absolute; top:50%; left:40%; width:80px; visibility: hidden;">
    <img src="{% static "img/loading-bar.gif" %}"></img>
</div>


<div class="container">


    {% if list_corpora  %}
        {% for key, corpora in list_corpora.items %}
            <h2>
                <div class="row">
                <div class="col-md-1 content"></div>
                    <span class="glyphicon glyphicon-cd" aria-hidden="true"></span>
                    {{ key }}
            </h2>
                    {% for corpus in corpora %}
                        <div id="corpus_{{corpus.id}}" class="corpusElt">
                            <div class="row">
                                <h4>
                                    <div class="col-md-1 content"></div>
                                    <div class="col-md-5 content">
                                        <a href="/projects/{{project.id}}/corpora/{{corpus.id}}">
                                            <span class="glyphicon glyphicon-file" aria-hidden="true"></span>
                                            {{corpus.name}}, <span id="corpus_{{corpus.id}}_ndocs">{{ corpus.count }} documents </span>
                                                              <span id="corpus_{{corpus.id}}_msg">{{ corpus.status_message }}</span>
                                        </a>
                                    </div>
                                    <div class="col-md-3 content"  id="corpus_{{corpus.id}}_tools">
                                        {% if corpus.hyperdata.statuses %}
                                            {% for state in corpus.hyperdata.statuses %}
                                                {% ifequal state.action "Workflow" %}
                                                        <a class="{% if not state.complete %}hidden{% endif %}"
                                                           href="/projects/{{project.id}}/corpora/{{corpus.id}}" title="View the corpus">
                                                            <button type="button" class="btn btn-default" aria-label="Left Align">
                                                                  <span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span>
                                                            </button>
                                                        </a>

                                                        <button type="button" class="btn btn-default {% if not state.complete %}hidden{% endif %}" data-container="body" data-toggle="popover" data-placement="bottom"  data-trigger="focus"
                                                            data-content="
                                                            <ul class=&quot;inside-popover&quot;>
                                                                <li
                                                                onclick=&quot;updateCorpus(event, {{corpus.id}})&quot;>
                                                                    <a href='#'>Recalculate ngram metrics</a> <br/> (can take a little while)
                                                                </li>
                                                            </ul>
                                                            ">
                                                            <span class="glyphicon glyphicon-repeat" aria-hidden="true"
                                                            title='Recalculate ngram scores and similarities'></span>
                                                        </button>

                                                        <!-- TODO: delete non seulement si state.complete mais aussi si state.error -->
                                                        <button type="button" class="btn btn-default" data-container="body" data-toggle="popover" data-placement="bottom"
                                                            data-content="
                                                            <ul id=&quot;{{corpus.id}}_trash_msg&quot; class=&quot;inside-popover&quot;>
                                                                <li
                                                                onclick=&quot;deleteCorpus(event, {{corpus.id}})&quot;>
                                                                    <a href='#'>Delete this</a>
                                                                </li>
                                                            </ul>
                                                            ">
                                                            <span class="glyphicon glyphicon-trash" aria-hidden="true"
                                                            title='Delete this corpus'></span>
                                                        </button>
                                                {% endifequal %}
                                            {% endfor %}
                                        {% else %}

                                                       <button type="button" class="btn btn-default" data-container="body" data-toggle="popover" data-placement="bottom"
                                                            data-content="
                                                            <ul id=&quot;{{corpus.id}}_trash_msg&quot; class=&quot;inside-popover&quot;>
                                                                <li
                                                                onclick=&quot;deleteCorpus(event, {{corpus.id}})&quot;>
                                                                    <a href='#'>Delete this</a>
                                                                </li>
                                                            </ul>
                                                            ">
                                                            <span class="glyphicon glyphicon-trash" aria-hidden="true"
                                                            title='Delete this corpus'></span>
                                                        </button>


                                        {% endif %}
                                    </div>
                                    <div class="col-md-3 content" id="corpus_{{corpus.id}}_status">
                                        {% if corpus.hyperdata.statuses %}
                                            {% for state in corpus.hyperdata.statuses %}
                                                    {% ifequal state.action "Workflow" %}
                                                        {% if state.complete %}
                                                            <span id="corpus_{{corpus.id}}_status_ok"
                                                                  class="glyphicon glyphicon-ok"
                                                                  aria-hidden="true"></span>

                                                        {% else %}
                                                            {% if state.error %}
                                                                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                                                                {{ state.error }}
                                                            {% else %}
                                                                <div class="progress">
                                                                    <div class=" progress-bar progress-bar-striped
                                                                                                progress-bar-success
                                                                                         "
                                                                                    role="progressbar" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100" style="width: 20%">
                                                                                  <span>
                                                                                      Upload
                                                                                  </span>
                                                                    </div>

                                                                    {% for state in corpus.hyperdata.statuses %}
                                                                    <!-- {% if state.action != "Workflow" %} -->
                                                                          <div class=" progress-bar progress-bar-striped
                                                                                            {% if state.complete %}
                                                                                                progress-bar-success
                                                                                                {% else %}
                                                                                                active
                                                                                            {% endif %}
                                                                                         "
                                                                                    role="progressbar" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100"
                                                                                    id="corpus_{{corpus.id}}_status_{{state.action}}" style="width: 20%">
                                                                                  <span>
                                                                                      {{ state.action }}
                                                                                            {% if not state.complete %}
                                                                                                Processing
                                                                                            {% endif %}

                                                                                  </span>
                                                                          </div>
                                                                          <!-- {% endif %} -->
                                                                    {% endfor %}
                                                                </div>
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endifequal %}
                                            {% endfor %}
                                        {% else %}
                                                    <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                                                    Error at parsing. Please create a new corpus. If this error persists then <a href="https://iscpif.fr/gargantext-feedback-and-bug-report/" target="blank">report</a> the bug with this id: {{ corpus.id }}.
                                        {% endif %}
                                    </div>
                                    <div class="col-md-1 content"></div>
                                </h4>
                            </div>
                        </div>
                    {% endfor %}
        {% endfor %}
    {% endif %}





                    <div class="modal fade" id="stack1" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                    <h3>Query to PubMed</h3>
                                </div>
                                <div class="modal-body">
                                    <p>One fine body…</p>
                                    <input id="daquery" type="text" class="input-lg" data-tabindex="2">
                                    <a onclick="getGlobalResults();" class="btn">Scan</a>
                                    <div id="results"></div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                                    <button onclick="doTheQuery();" disabled id="id_thebutton" type="button" class="btn btn-primary">Explore a sample!</button>
                                </div>
                            </div><!-- /.modal-content -->
                        </div><!-- /.modal-dialog -->
                    </div><!-- /.modal -->

                    <!-- Modal -->
                    <div class="modal fade" id="addcorpus" tabindex="-1" role="dialog" aria-labelledby="myModalLabel2" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>

                                    <h3 id="corpus" class="help">Add a Corpus
                                    </a>
                                  </h3>
                                </div>
                                <div class="modal-body">
                                  <!-- FAQ -->
                                    <form id="id_form" enctype="multipart/form-data" action="/projects/{{project.id}}/" method="post">
                                        {% csrf_token %}
                                        <table cellpadding="5">


                                            {% for field in form %}
                                            <tr>
                                                <th>{{field.label_tag}}</th>
                                                <td>
                                                    {{ field.errors }}
                                                    {{ field }}
                                                    {% if field.name == 'name' %}
                                                    <span onclick="getGlobalResults(this);" id="scanpubmed"></span>
                                                    <div id="theresults"></div>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                            <tr>
                                                <th></th>
                                                <td>
                                                    <div id="div-fileornot" style="visibility: hidden;">
                                                        Do you have a file already? &nbsp;
                                                        <input type="radio" id="file_yes" name="file1" onclick="FileOrNotFile(this.value);checkReady()" class="file1" value="true" checked> Yes </input>
                                                        <input type="radio" id="file_no" name="file1" onclick="FileOrNotFile(this.value);checkReady()" class="file1" value="false"> No </input>
                                                    </div>
                                                </td>
                                            </tr>
                                        </table>
                                    </form>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-default" data-dismiss="modal">
                                            <span class="glyphicon glyphicon-remove" aria-hidden="true" ></span>
                                            Close
                                        </button>
                                        <button onclick='bringDaNoise();' id="submit_thing" disabled class="btn btn-primary" >
                                            <span class="glyphicon glyphicon-ok" aria-hidden="true" ></span>
                                            Process this!
                                        </button><span id="simpleloader"></span>
                                    </div>
                                </div>
                            </div><!-- /.modal-content -->
                        </div><!-- /.modal-dialog -->
                    </div><!-- /.modal -->
                    <!-- Modal -->
                    <div id="wait" class="modal fade">
                      <div class="modal-dialog" role="document">
                        <div class="modal-content">
                          <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                              <span aria-hidden="true">&times;</span>
                            </button>
                        <h2 class="modal-title"><h2><span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span>  Building the corpus...</h2>
                      </div>
                      <div class="modal-body">
                        <center>
                        <p>
                        Gargantext is gathering your texts       <br>
                         and need some time to eat it.           <br>
                        Duration depends on the size of the dish.
                        </p>
                        </center>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Continue on Gargantext</button>
                      </div>
                    </div><!-- /.modal-content -->
                  </div><!-- /.modal-dialog -->
                </div><!-- /.modal -->
                    <script type="text/javascript" src="{% static "lib/jquery/1.11.2/jquery-ui.js" %}"></script>
                    <!-- <script type="text/javascript" src="{% static "lib/gargantext/help.js" %}"></script> -->
                    <script type="text/javascript">

                        var corporaDivs = document.getElementsByClassName('corpusElt')

                        // all corpora ids ======================================

                        var corporaIds = []

                        // for corpora ids whose delete is pending
                        var trashedIds = {}

                        for (var i = 0 ; i < corporaDivs.length ; i++) {
                          // ex: corpus_1198
                          divId = corporaDivs[i].id
                          if (divId) {
                            var corpusId = divId.match(/[0-9]+$/).pop()
                            corporaIds.push(corpusId)
                          }
                        }

                        var activeCorporaIds = testActiveCorpora()

                        if (activeCorporaIds.length) {
                          // initial checks if page reloaded with active corpora
                          keepCheckingProjectStatus()
                        }

                        // cookie ajax helper ==================================
                        function getCookie(name) {
                            var cookieValue = null;
                            if (document.cookie && document.cookie != '') {
                                var cookies = document.cookie.split(';');
                                for (var i = 0; i < cookies.length; i++) {
                                    var cookie = jQuery.trim(cookies[i]);
                                    // Does this cookie string begin with the name we want?
                                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                        break;
                                    }
                                }
                            }
                            return cookieValue;
                        }

                        // =====================================================
                        // search queries and crawling =========================
                        // =====================================================
                        var thequeries = [] ;

                        // load the template's value for N scan size
                        var querySize = parseInt({{query_size}}) ;

                        // TODO if is_admin

                        function doTheQuery() {
                            if ( $('#submit_thing').prop('disabled') ) return;
                            console.log("in doTheQuery:");
                            var origQuery = $("#id_name").val()


                            var pubmedifiedQuery = {
                                query : JSON.stringify(thequeries) ,
                                string: origQuery ,
                                N : querySize
                            } ;
                            console.log(pubmedifiedQuery)

                            var projectid = window.location.href.split("projects")[1].replace(/\//g, '')//replace all the slashes

                            $.ajax({
                                // contentType: "application/json",
                                url: window.location.origin+"/moissonneurs/pubmed/save/"+projectid,
                                data: pubmedifiedQuery,
                                type: 'POST',
                                beforeSend: function(xhr) {
                                    xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));
                                },
                                success: function(data) {
                                    console.log("in doTheQuery() Ajax.Success:")
                                    // console.log(data)
                                    setTimeout(
                                        function() {
                                            $('#addcorpus').modal('hide');
                                            $("#wait").modal("show");

                                        }, 600);
                                    },
                                    error: function(result) {
                                        console.log("in doTheQuery(). Data not found");
                                    }
                            });
                        }

                        function checkReady() {
                          // checks if we allow [submit]
                          // *after* any modification
                          // in the form "Add a corpus"

                          var type = $("#id_type").val()

                          // 5 booleans
                          var nameField = $("#id_name").val() != ""
                          var typeField = (type != "") && (type != "0")
                          var fileField = $("#id_file").val() != ""
                          var wantfileField = $("#file_yes").prop("checked")
                          var crawling = ((type==3)||(type==8)||(type==9)) && ! wantfileField

                          // console.warn("bool nameField",nameField)
                          // console.warn("bool typeField",typeField)
                          // console.warn("bool fileField",fileField)
                          // console.warn("bool wantfileField",wantfileField)
                          // console.warn("bool crawling",crawling)

                          if (! crawling) {
                              $("#submit_thing").prop('disabled' , !(nameField && typeField && fileField))
                          }
                        }

                        function bringDaNoise() {
                            var theresults = $("#theresults").html()
                            if( theresults && theresults.search("No results")==-1 ) {
                                console.log("we've in dynamic mode")
                                $("#simpleloader").html('<img width="30px" src="{% static "img/loading-bar.gif" %}"></img>')
                                $("#submit_thing").prop('onclick',null);

                                var theType = $("#id_type option:selected").html();
                                console.log("consoling the type: ")
                                console.log(theType)
                                if(theType=="Pubmed [XML]") doTheQuery();
                                if(theType=="ISTex") {
                                    var origQuery = $("#id_name").val()
                                    console.log("printing the results:")
                                    console.log(origQuery)
                                    testISTEX(origQuery.replace(" ","+"), querySize)
                                }
                            }
                            else {
                                console.log("we dont have nothing inside results div")
                                if ( $("#id_file").is(':visible') ) {
                                    console.log("we're in upload-file mode")

                                    var namefield = $("#id_name").val()!=""
                                    var typefield = $("#id_type").val()!=""
                                    var filefield = $("#id_file").val()!=""
                                    if( namefield && typefield && filefield ) {
                                        $("#simpleloader").html('<img width="30px" src="{% static "img/loading-bar.gif" %}"></img>')
                                        $("#submit_thing").prop('onclick',null);
                                        $( "#id_form" ).submit();
                                    }
                                }

                            }

                            // schedule periodic checks of status of active corpora
                            keepCheckingProjectStatus()
                        }

                        function getGlobalResults(value){

                            console.log("in getGlobalResults()")
                            // AJAX to django
                            var pubmedquery = $("#id_name").val()
                            // var Npubs = $("#id_N").val();
                            if(pubmedquery=="") return;
                            var formData = {query:pubmedquery , N:querySize}
                            $("#theresults").html('<img width="30px" src="{% static "img/loading-bar.gif" %}"></img>')
                            console.log("disabling "+"#"+value.id)
                            $("#"+value.id).prop('onclick',null);
                            var theType = $("#id_type option:selected").html();
                            var SourceTypeId = $("#id_type").val()
                            //alert(SourceTypeId);
                            //PUBMED = 3
                            if(SourceTypeId == "3") {
                                $.ajax({
                                    // contentType: "application/json",
                                    url: window.location.origin+"/moissonneurs/pubmed/query",
                                    data: formData,
                                    type: 'POST',
                                    beforeSend: function(xhr) {
                                        xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));
                                    },
                                    success: function(data) {
                                        console.log("SUCCESS")
                                        console.log("in getGlobalResults")
                                        console.log(data)
                                        console.log("enabling "+"#"+value.id)
                                        $("#"+value.id).attr('onclick','getGlobalResults(this);');
                                        // $("#submit_thing").prop('disabled' , false)
                                        $("#submit_thing").html("Process a {{ query_size }} sample!")

                                        thequeries = data
                                        var N=0,k=0;

                                        for(var i in thequeries) N += thequeries[i].count
                                        if( N>0) {
                                            $("#theresults").html("<i> <b>"+pubmedquery+"</b>: "+N+" publications in the last 5 years</i><br>")
                                            $('#submit_thing').prop('disabled', false);
                                        } else {
                                            $("#theresults").html("<i>  <b>"+pubmedquery+"</b>: No results!.</i><br>")
                                            if(data[0]==false)
                                            $("#theresults").html("Pubmed connection error!</i><br>")
                                            $('#submit_thing').prop('disabled', true);
                                        }

                                    },
                                    error: function(result) {
                                        $("#theresults").html("Pubmed connection error.</i><br>")
                                        $('#submit_thing').prop('disabled', true);
                                    }
                                });
                            }

                            if(SourceTypeId == "8") {
                                console.log(window.location.origin+"moissonneurs/istex/query")
                                $.ajax({
                                    // contentType: "application/json",
                                    url: window.location.origin+"/moissonneurs/istex/query",
                                    data: formData,
                                    type: 'POST',
                                    beforeSend: function(xhr) {
                                        xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));
                                    },
                                    success: function(data) {
                                        console.log("in getGlobalResults: Ajax(ISTex)")
                                        console.log("enabling "+"#"+value.id)
                                        $("#"+value.id).attr('onclick','getGlobalResults(this);');
                                        // $("#submit_thing").prop('disabled' , false)
                                        $("#submit_thing").html("Process a {{ query_size }} sample!")

                                        thequeries = data
                                        var N=data.length,k=0;
                                        // for(var i in thequeries) N += thequeries[i].count
                                        if( N>1) {
                                            var total = JSON.parse(data).total
                                            console.log("N: "+total)
                                            $("#theresults").html("<i> <b>"+pubmedquery+"</b>: "+total+" publications.</i><br>")
                                            $('#submit_thing').prop('disabled', false);
                                        } else {
                                            $("#theresults").html("<i>  <b>"+data[0]+"</b></i><br>")
                                            $('#submit_thing').prop('disabled', true);
                                        }

                                    },
                                    error: function(result) {
                                        console.log("Data not found");
                                    }
                                });
                            }
                            //<option value="9">SCOAP [XML]</option>
                            if (SourceTypeId == "9"){
                              $.ajax({
                                  // contentType: "application/json",
                                  url: window.location.origin+"/moissonneurs/cern/query",
                                  data: formData,
                                  type: 'POST',
                                  beforeSend: function(xhr) {
                                      xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));
                                  },
                                  success: function(data) {
                                      console.log("SUCCESS")
                                      console.log("enabling "+"#"+value.id)
                                      $("#"+value.id).attr('onclick','getGlobalResults(this);');
                                      $("#submit_thing").prop('disabled' , false)
                                      //$("#submit_thing").html("Process a {{ query_size }} sample!")

                                      N = data["results_nb"]

                                      if(N > 0) {
                                          if (N <= {{query_size}}){
                                            $("#theresults").html("<i> <b>"+pubmedquery+"</b>: "+N+" publications </i><br>")
                                            $("#submit_thing").html("Download!")
                                            $("#submit_thing").prop('disabled' , false)
                                            //$("#submit_thing").attr('onclick', testCERN(query, N));
                                            $("#submit_thing").on("click", function(){
                                              testCERN(pubmedquery, N);
                                            //$("#submit_thing").onclick()
                                          })}
                                          //(N > {{query_size}})
                                          else {
                                            $("#theresults").html("<i> <b>"+pubmedquery+"</b>: "+N+" publications </i><br>")
                                            $('#submit_thing').prop('disabled', false);
                                            $("#submit_thing").html("Processing a sample file")
                                            $("#submit_thing").on("click", function(){
                                              testCERN(pubmedquery, N);
                                            //$("#submit_thing").onclick()
                                          })}
                                      }


                                      else {
                                          $("#theresults").html("<i>  <b>"+pubmedquery+"</b>: No results!.</i><br>")
                                          if(data[0]==false)
                                          $("#theresults").html(theType +" connection error!</i><br>")
                                          $('#submit_thing').prop('disabled', true);
                                      }

                                  },
                                  error: function(result) {
                                      $("#theresults").html(theType +" connection error!</i><br>")
                                      $('#submit_thing').prop('disabled', true);
                                  }
                              });

                            }

                            //MULTIVAC = 10

                            if (SourceTypeId == "10"){
                              $.ajax({
                                  // contentType: "application/json",
                                  url: window.location.origin+"/moissonneurs/multivac/query",
                                  data: formData,
                                  type: 'POST',
                                  beforeSend: function(xhr) {
                                      xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));
                                  },
                                  success: function(data) {
                                      console.log(data)
                                      console.log("SUCCESS")
                                      console.log("enabling "+"#"+value.id)
                                      
                                      // $("#"+value.id).attr('onclick','getGlobalResults(this);');
                                      $("#submit_thing").prop('disabled' , false)
                                      //$("#submit_thing").html("Process a {{ query_size }} sample!")

                                      N = data["results_nb"]

                                      if(N > 0) {
                                          if (N <= {{query_size}}){
                                            $("#theresults").html("<i> <b>"+pubmedquery+"</b>: "+N+" publications </i><br>")
                                            $("#submit_thing").html("Download!")
                                            $("#submit_thing").prop('disabled' , false)
                                            //$("#submit_thing").attr('onclick', testCERN(query, N));
                                            $("#submit_thing").on("click", function(){
                                              saveMultivac(pubmedquery, N);
                                            //$("#submit_thing").onclick()
                                          })}
                                          //(N > {{query_size}})
                                          else {
                                            $("#theresults").html("<i> <b>"+pubmedquery+"</b>: "+N+" publications </i><br>")
                                            $('#submit_thing').prop('disabled', false);
                                            $("#submit_thing").html("Processing a sample file")
                                            $("#submit_thing").on("click", function(){
                                              saveMultivac(pubmedquery, N);
                                            //$("#submit_thing").onclick()
                                          })}
                                      }


                                      else {
                                          $("#theresults").html("<i>  <b>"+pubmedquery+"</b>: No results!.</i><br>")
                                          if(data[0]==false)
                                          $("#theresults").html(theType +" connection error!</i><br>")
                                          $('#submit_thing').prop('disabled', true);
                                      }

                                  },
                                  error: function(result) {
                                      $("#theresults").html(theType +" connection error</i><br>")
                                      $('#submit_thing').prop('disabled', true);
                                  }
                              });

                            }


                            //HAL = 11

                            if (SourceTypeId == "11"){
                              $.ajax({
                                  // contentType: "application/json",
                                  url: window.location.origin+"/moissonneurs/hal/query",
                                  data: formData,
                                  type: 'POST',
                                  beforeSend: function(xhr) {
                                      xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));
                                  },
                                  success: function(data) {
                                      console.log(data)
                                      console.log("SUCCESS")
                                      console.log("enabling "+"#"+value.id)
                                      
                                      // $("#"+value.id).attr('onclick','getGlobalResults(this);');
                                      $("#submit_thing").prop('disabled' , false)
                                      //$("#submit_thing").html("Process a {{ query_size }} sample!")

                                      N = data["results_nb"]

                                      if(N > 0) {
                                          if (N <= {{query_size}}){
                                            $("#theresults").html("<i> <b>"+pubmedquery+"</b>: "+N+" publications </i><br>")
                                            $("#submit_thing").html("Download!")
                                            $("#submit_thing").prop('disabled' , false)
                                            //$("#submit_thing").attr('onclick', testCERN(query, N));
                                            $("#submit_thing").on("click", function(){
                                              saveALL(pubmedquery, N);
                                            //$("#submit_thing").onclick()
                                          })}
                                          //(N > {{query_size}})
                                          else {
                                            $("#theresults").html("<i> <b>"+pubmedquery+"</b>: "+N+" publications </i><br>")
                                            $('#submit_thing').prop('disabled', false);
                                            $("#submit_thing").html("Processing a sample file")
                                            $("#submit_thing").on("click", function(){
                                              saveALL(pubmedquery, N);
                                            //$("#submit_thing").onclick()
                                          })}
                                      }


                                      else {
                                          $("#theresults").html("<i>  <b>"+pubmedquery+"</b>: No results!.</i><br>")
                                          if(data[0]==false)
                                          $("#theresults").html(theType +" connection error!</i><br>")
                                          $('#submit_thing').prop('disabled', true);
                                      }

                                  },
                                  error: function(result) {
                                      $("#theresults").html(theType +" connection error</i><br>")
                                      $('#submit_thing').prop('disabled', true);
                                  }
                              });

                            }


                        }

                        // CSS events for selecting one Radio-Input
                        function FileOrNotFile( value ) {
                            var showfile = JSON.parse(value)
                            var theType = $("#id_type option:selected").html();
                            // @upload-file events
                            if (showfile) {
                                console.log("You've clicked the YES")
                                $("#id_file").show()
                                $('label[for=id_file]').show();
                                $("#id_name").attr("placeholder", "");
                                $("#scanpubmed").html("")
                                $("#theresults").html("")
                                // $('#submit_thing').prop('disabled', false); // cf. checkReady
                                $( "#id_name" ).on('input',null);
                                $("#submit_thing").html('<span class="glyphicon glyphicon-ok" aria-hidden="true" ></span> Process this!')
                            }
                            // @dynamic-query events
                            else {
                                console.log("You've clicked the NO")
                                $("#id_file").hide()
                                $('label[for=id_file]').hide();
                                $("#id_name").attr("placeholder", " [ Enter your query here ] ");
                                $("#id_name").focus();
                                $("#scanpubmed").html('<a class="btn btn-primary">Scan</a>')//+'Get: <input id="id_N" size="2" type="text"></input>')
                                $("#theresults").html("")
                                $("#submit_thing").prop('disabled' , true)

                                $( "#id_name" ).on('input',function(e){
                                    console.log($(this).val())
                                    if(theType=="Pubmed [XML]")
                                    testPUBMED( $(this).val() )
                                });
                            }
                        }

                        //CSS events for changing the Select element

                        function CustomForSelect( selectedId ) {
                            // show Radio-Inputs and trigger FileOrNotFile>@upload-file events

                            // selectedId = $("#id_type").val()
                            console.log("selected:", selectedId);

                            // by typeID: 3 = PUBMED, 8 = ISTEX, 9 = CERN
                            if (  selectedId == "3" 
                               || selectedId == "8" 
                               || selectedId == "9" 
                               || selectedId == "10" 
                               || selectedId == "11" 
                                ) {
                                console.log("show the button for: " + selectedId)
                                $("#div-fileornot").css("visibility", "visible");
                                $("#div-fileornot").show();

                                //$("#file_yes").click();
                                $("#submit_thing").html("Process this!")

                                // (todo factorize)
                                // if not crawling, the submit_thing
                                //   will be enabled by checkReady()
                                // if crawling, submit_thing
                                //   will be enabled by getGlobalResults()
                            }
                            // hide Radio-Inputs and trigger @upload-file events
                            else {
                                console.log("hide the button")
                                $("#div-fileornot").css("visibility", "hidden");
                                $("#id_file").show()
                                $('label[for=id_file]').show();
                                FileOrNotFile( "true" )
                            }
                        }

                        var LastData = []
                        function NSuggest_CreateData(q, data) {
                            console.log("in the new NSuggest_CreateData:")
                            LastData = data;
                            // console.log(LastData)
                            console.log("adding class ui-widget")
                            $("#id_name").removeClass( "ui-widget" ).addClass( "ui-widget" )
                            $( "#id_name" ).autocomplete({
                                source: LastData
                            });
                            return data;
                        }

                        function testPUBMED( query ) {
                            LastData = []
                            if(!query || query=="") return;
                            var pubmedquery = encodeURIComponent(query)
                            $.ajax({
                                type: 'GET',
                                url: "http://www.ncbi.nlm.nih.gov/portal/utils/autocomp.fcgi?dict=pm_related_queries_2&q="+pubmedquery,
                                // data:"db="+db+"&query="+query,
                                contentType: "application/json",
                                dataType: 'jsonp'
                            });
                            return false;
                        }
                        function testCERN(query, N){
                          //alert("CERN!")
                          console.log("In testCern")
                          if(!query || query=="") return;
                          //var origQuery = query

                          var data = { "query" : query , "N": N };
                          var projectid = window.location.href.split("projects")[1].replace(/\//g, '')//replace all the slashes
                          console.log(data)
                          $.ajax({
                              dataType: 'json',
                              url: window.location.origin+"/moissonneurs/cern/save/"+projectid,
                              data: data,
                              type: 'POST',
                              beforeSend: function(xhr) {
                                  xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));
                              },
                              success: function(data) {
                                  console.log("ajax_success: in testCERN()")
                                  console.log(data)
                                  alert("OK")
                                  setTimeout(
                                      function() {
                                        $('#addcorpus').modal('hide')
                                        $("#wait").modal("show");
                                        // setTimeout(
                                        //   function(){
                                        //     location.reload();
                                        //
                                        //   }, 600);
                                        // )
                                        //setTimeout(, 300)
                                        //location.reload();
                                      }, 600);
                                },


                              error: function(data) {
                                console.log(data)
                                setTimeout(
                                    function() {
                                        $('#addcorpus').modal('hide')
                                        $("#wait").modal("show")
                                        //setTimeout(, 300)
                                        //location.reload();
                                      }, 600);

                                  },
                              });
                          }

                        function testISTEX(query,N) {
                            console.log("in testISTEX:");
                            if(!query || query=="") return;
                            var origQuery = query

                            var postQuery = { query : query , N: N }

                            var projectid = window.location.href.split("projects")[1].replace(/\//g, '')//replace all the slashes

                            $.ajax({
                                // contentType: "application/json",
                                url: window.location.origin+"/moissonneurs/istex/save/"+projectid,
                                data: postQuery,
                                type: 'POST',
                                beforeSend: function(xhr) {
                                    xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));
                                },
                                success: function(data) {
                                    console.log("ajax_success: in testISTEX()")
                                    // console.log(data)
                                    setTimeout(
                                        function() {
                                            $('#addcorpus').modal('hide');
                                            $("#wait").modal("show");

                                            //location.reload();
                                        }, 600);
                                    },
                                error: function(result) {
                                      console.log("in testISTEX(). Data not found");
                                    }
                                });
                            }

                        function saveMultivac(query, N){
                          console.log("In Multivac")
                          
                          if(!query || query=="") return;
                          console.log(query)
                          
                              //var origQuery = query
                          var data = { "query" : query , "N": N };
                          
                          // Replace all the slashes
                          var projectid = window.location.href.split("projects")[1].replace(/\//g, '')
                          
                          console.log(data)
                          $.ajax({
                              dataType: 'json',
                              url: window.location.origin+"/moissonneurs/multivac/save/"+projectid,
                              data: data,
                              type: 'POST',
                              beforeSend: function(xhr) {
                                  xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));
                              },
                              success: function(data) {
                                  console.log("ajax_success: in saveMultivac()")
                                  console.log(data)
                                  alert("OK")
                                  setTimeout(
                                      function() {
                                        $('#addcorpus').modal('hide')
                                        $("#wait").modal("show");
                                      }, 600);
                                },


                              error: function(data) {
                                console.log(data)
                                setTimeout(
                                    function() {
                                        $('#addcorpus').modal('hide')
                                        $("#wait").modal("show")
                                        //setTimeout(, 300)
                                        //location.reload();
                                      }, 600);

                                  },
                              });
                          }

                        function saveALL(query, N){
                          console.log("In Gargantext")
                          
                          if(!query || query=="") return;
                          console.log(query)
                          
                              //var origQuery = query
                          var data = { "query" : query , "N": N };
                          
                          // Replace all the slashes
                          var projectid = window.location.href.split("projects")[1].replace(/\//g, '')
                          
                          console.log(data)
                          $.ajax({
                              dataType: 'json',
                              url: window.location.origin+"/moissonneurs/hal/save/"+projectid,
                              data: data,
                              type: 'POST',
                              beforeSend: function(xhr) {
                                  xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));
                              },
                              success: function(data) {
                                  console.log("ajax_success: in Gargantext()")
                                  console.log(data)
                                  alert("OK")
                                  setTimeout(
                                      function() {
                                        $('#addcorpus').modal('hide')
                                        $("#wait").modal("show");
                                      }, 600);
                                },


                              error: function(data) {
                                console.log(data)
                                setTimeout(
                                    function() {
                                        $('#addcorpus').modal('hide')
                                        $("#wait").modal("show")
                                        //setTimeout(, 300)
                                        //location.reload();
                                      }, 600);

                                  },
                              });
                          }






                        function deleteCorpus(e, corpusId) {
                          // prevents scroll back to top of page
                          e.preventDefault()

                          // register pending operation
                          trashedIds[corpusId] = true ;

                          // visual loader wheel
                          var statusDiv = document.getElementById("corpus_"+corpusId+"_status")
                          statusDiv.innerHTML = '<img width="10%" src="{% static "img/ajax-loader.gif"%}"></img>'
                          var trashMsgDiv = document.getElementById(corpusId+"_trash_msg")
                          trashMsgDiv.innerHTML = '<h5>Deleting corpus, please wait</h5>'

                          // REST and callback
                          garganrest.nodes.delete(
                              corpusId,
                              function(){
                                  $('#corpus_'+corpusId).remove()
                                  delete trashedIds[corpusId]
                                  // remove any popover too
                                  $('.popover').remove();
                                }
                              );
                        }


                        function updateCorpus(e, corpusId) {
                          // prevents scroll back to top of page
                          e.preventDefault()

                          // show 'waiting'
                          var statusDiv = document.getElementById("corpus_"+corpusId+"_status")
                          var previousStatus = statusDiv.innerHTML
                          statusDiv.innerHTML = '<img width="10%" src="{% static "img/ajax-loader.gif"%}"></img>'

                          // REST and callback
                          garganrest.metrics.update(corpusId, function(){
                            statusDiv.innerHTML = '<div class="statusinfo">Corpus updated</div>'

                            // revert visual
                            setTimeout(function(){ statusDiv.innerHTML = previousStatus }, 2000);
                          })

                        }

                            {% if donut %}
                            // Morris Donut Chart
                            Morris.Donut({
                                element: 'hero-donut',
                                data: [

                                    {% for part in donut %}
                                    {label: '{{ part.source }}', value: {{ part.part }} },
                                    {% endfor %}


                                ],
                                colors: ["@white", "@white"],
                                //colors: ["#30a1ec", "#76bdee"],
                                formatter: function (y) { return y + "%" }
                            });
                            {% endif %}


                        // =====================================================

                        $('#wait').on('hidden.bs.modal', function (e) {
                          // reload page when dismiss the info box
                          window.location.reload()
                        })


                        // =====================================================
                        // corpus-status checking ==============================
                        // =====================================================

                        // ------------------------------
                        // 1) helper progressbar function
                        // -------------------------------
                        function updateCorpusProgressbar(crid, statuses, the_status_url) {
                          if (statuses && statuses[0]) {
                            // 0 is status of whole WORKFLOW
                            var statusW = statuses[0]
                            if (statusW.complete) {
                              // show checkbox
                              $('#corpus_'+crid+'_status').html(
                                  '<span id="corpus_'+crid+'_status_ok" '
                                  + ' class="glyphicon glyphicon-ok"></span>'
                              )

                              // show all tools
                              var cTools = document.getElementById('corpus_'+crid+'_tools').children
                              for (var i in cTools) {
                                var elt = cTools[i]
                                if (elt.classList) {
                                  elt.classList.remove("hidden")
                                }
                              }
                            }
                            // workflow incomplete: we check each action in [1,4]
                            else {
                              var subStatuses = statuses.slice(1,5)
                              // console.warn(subStatuses)
                              for (var j in subStatuses) {
                                var stepOk = subStatuses[j]['complete']
                                var stepError = subStatuses[j]['error']

                                // stepName parmi 'Docs','Ngrams','Index','Lists'
                                var stepName = subStatuses[j]['action']

                                // debug
                                // console.warn(stepName)

                                var pgbarId = 'corpus_'+crid+'_status_'+stepName

                                // if error
                                if (stepError && stepError != 'null') {
                                  $('#corpus_'+crid+'_status').html(
                                    '<p class="workflow_error">'
                                    + 'Error in corpus parsing at step '
                                    + j +' (' + stepName + ')'
                                    + JSON.stringify(stepError) +
                                    + ' <a href="https://www.iscpif.fr/gargantext-feedback-and-bug-report/">'
                                    +'(bug report here)'
                                    +'</a></p>'
                                  )
                                }
                                // normal cases: update progressbar ------------
                                else {
                                  var progressbar = document.getElementById(pgbarId)

                                  if (progressbar) {
                                    console.log('updating '+pgbarId, "stepOk:", stepOk)

                                    // A: done
                                    if (stepOk || stepOk == "true") {
                                      // make progressbar segment green
                                      if (progressbar.className
                                          && progressbar.className.match('active')) {
                                        progressbar.classList.remove("active")
                                        progressbar.classList.add("progress-bar-success")
                                      }
                                      // remove message if any
                                      document.getElementById('corpus_'+crid+'_msg').innerHTML = ""
                                      // for docs parsing, also update nDocs
                                      if (stepName == "Docs" && stepOk) {
                                        var stepProgress = subStatuses[j]['progress']
                                        document.getElementById('corpus_'+crid+'_ndocs')
                                                .innerHTML = (stepProgress-1) + " documents"
                                      }
                                    }
                                    // B: active
                                    else {
                                      progressbar.classList.add("active")
                                    }
                                  }
                                  // C: new action => new bar segment
                                  else {
                                    console.log('creating '+pgbarId)

                                    barSegmentHtml = '<div class="progress-bar progress-bar-striped'
                                    barSegmentHtml += (stepOk ? ' progress-bar-success' : ' active') + '"'
                                    barSegmentHtml += 'role="progressbar" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100"'
                                    barSegmentHtml += 'id="corpus_'+crid+'_status_'+stepName+'" style="width: 20%">'
                                    barSegmentHtml +=  '<span>'+stepName
                                    barSegmentHtml += '</span></div>'

                                    $('#corpus_'+crid+'_status > .progress')
                                      .append(barSegmentHtml)
                                  }
                                }
                                // ---------------------------------------------
                              } // end detailed check
                            }
                          } // end if statuses array
                          else {
                            console.error("Wrong status API return format "
                                          + "for url" + the_status_url)
                          }
                          return null
                        } // end function

                        // ---------------------------------------------------
                        // 2 - main status check function on activeCorporaIds
                        // ---------------------------------------------------
                        function updateCorporaStates(someCorporaIds) {
                          for (var i in someCorporaIds) {
                            // !careful with closure, async function & loop on i
                            // cf stackoverflow.com/a/21819961/2489184
                            (function(i) {
                              var myCrid = someCorporaIds[i]
                              var the_status_url = "/api/nodes/"+myCrid+"/status?format=json"
                              // iterate ajax checks
                              $.ajax({
                                type: 'GET',
                                url: the_status_url,
                                success: function(data) {
                                  var statuses = data['statuses']
                                  // console.warn("running callback for corpus id:" + myCrid)
                                  updateCorpusProgressbar(myCrid, statuses, the_status_url)
                                },
                                error: function(data, s) {
                                  if (trashedIds[myCrid]) {
                                    return null
                                  }
                                  else {
                                    console.warn("status GET: ajax err (s="+s+")")
                                    console.log(data)
                                  }
                                },
                                beforeSend: function(xhr) {
                                  xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));
                                }
                              }) // ajax: did 1 corpus
                            })(i)
                          } // did all corpora
                        }

                        // -----------------------------------------------------
                        // 3 - for testing on client side which need refresh
                        // -----------------------------------------------------
                        function testActiveCorpora() {
                          var activeCorporaIds = []
                          for (var i in corporaIds) {
                            var crid = corporaIds[i]
                            if ((! document.getElementById('corpus_'+crid+'_status_ok'))
                                && (! trashedIds[crid])) {
                              activeCorporaIds.push(crid)
                            }
                          }
                          return activeCorporaIds
                        }

                        // -----------------------------------------------------
                        // 4 - running the check at regular intervals until done
                        // -----------------------------------------------------

                        var nChecks = 0
                        var currentJob = null
                        function keepCheckingProjectStatus() {
                          console.log("checking status", nChecks)
                          nChecks ++

                          // local check for active corpora
                          var newActiveCorporaIds = testActiveCorpora()

                          if (newActiveCorporaIds.length) {
                            // start remote calls
                            updateCorporaStates(newActiveCorporaIds)
                            if (nChecks > {{status_refresh_max_attempts}}) {
                              // we abandon after 5 checks
                              console.warn("stopping status checks for corpora:",
                                            newActiveCorporaIds)
                              nChecks = 0
                              return null
                            }
                            else {
                              // decreasing intervals (preserving DB while "loosing interest")
                              var nextTime = nChecks * {{status_refresh_initial_interval}}
                              // schedule next check
                              currentJob = setTimeout(keepCheckingProjectStatus, nextTime)
                              console.log("next status check in", nextTime/1000, "s" )
                              return false
                            }
                          }
                          else {
                            console.info("OK, all corpora ingestion complete")
                            nChecks = 0
                            return true
                          }
                        }

                        function stopCheckingProjectStatus() {
                          clearTimeout(currentJob)
                        }
                    </script>




                            {% endblock %}
